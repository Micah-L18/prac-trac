<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drill Library - PracTrac</title>
    <link rel="stylesheet" href="/css/glass-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .drill-card {
            background: var(--glass-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: all 0.3s ease;
            position: relative;
        } 
        .drill-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent-orange);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .drill-card.favorite {
            border-color: var(--accent-amber);
        }
        .favorite-star {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--glass-border);
        }
        .favorite-star.active {
            color: var(--accent-amber);
        }
        .favorite-star:hover {
            transform: scale(1.2);
        }
        .drill-category {
            background: var(--accent-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 0px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            margin-bottom: var(--spacing-sm);
        }
        .drill-difficulty {
            display: flex;
            gap: 2px;
            margin-bottom: var(--spacing-sm);
        }
        .star {
            color: var(--accent-amber);
            font-size: 16px;
        }
        .star.empty {
            color: var(--glass-border);
        }
        .filter-tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }
        .filter-tab {
            background: var(--glass-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .filter-tab.active,
        .filter-tab:hover {
            background: var(--accent-orange);
            color: white;
            border-color: var(--accent-orange);
        }
        
        .ownership-tab {
            transition: all 0.3s ease;
        }
        
        .ownership-tab:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .drill-stats {
            background: var(--glass-tertiary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-md);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }
        .drill-stat {
            text-align: center;
        }
        .drill-stat-value {
            font-weight: 600;
            color: var(--accent-orange);
        }
        .drill-stat-label {
            color: var(--text-tertiary);
            font-size: 11px;
        }
        
        /* Multi-select option styles */
        .option-tag {
            background: var(--glass-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            font-size: var(--font-size-sm);
        }
        
        .option-tag:hover {
            background: var(--glass-primary);
            border-color: var(--accent-orange);
        }
        
        .option-tag.selected {
            background: var(--accent-orange);
            border-color: var(--accent-orange);
            color: white;
        }
        
        .option-tag.selected:hover {
            background: #ff7a35;
        }
        
        .option-tag.custom {
            border-left: 3px solid #4CAF50;
            position: relative;
        }
        
        .option-tag.custom::after {
            content: "‚òÖ";
            position: absolute;
            top: -2px;
            right: 2px;
            font-size: 8px;
            color: #4CAF50;
        }
        
        .option-tag.custom.selected::after {
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-content">
            <a href="index.html" class="logo">üèê PracTrac</a>
            
            <!-- Mobile menu toggle button -->
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            
            <!-- Desktop navigation -->
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="practice.html">Practice Plans</a></li>
                    <li><a href="past-practices.html">Past Practices</a></li>
                    <li><a href="roster.html">Roster</a></li>
                    <li><a href="drills.html" class="active">Drills</a></li>
                    <li><a href="settings.html">Settings</a></li>
                </ul>
            </nav>
            
            <!-- Mobile menu -->
            <nav class="mobile-menu">
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="practice.html">Practice Plans</a></li>
                    <li><a href="past-practices.html">Past Practices</a></li>
                    <li><a href="roster.html">Roster</a></li>
                    <li><a href="drills.html" class="active">Drills</a></li>
                    <li><a href="settings.html">Settings</a></li>
                </ul>
            </nav>
            
            <div class="nav-user">
                <span id="userGreeting">Guest User</span>
                <a href="login.html" class="login-link" style="margin-left: 10px;">Login</a>
                <div id="teamSelector" class="team-selector-container" style="display: none; margin-left: 10px;">
                    <!-- Team selector will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </nav>

    <main class="main-container">
        <!-- Header -->
        <section class="flex-between mb-xl">
            <div>
                <h1 style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-sm);">
                    Drill Library
                </h1>
                <p style="color: var(--text-secondary); font-size: var(--font-size-lg);">
                    Professional volleyball drills with custom statistics tracking
                </p>
            </div>
            <button class="glass-button primary" onclick="createCustomDrill()">
                ‚ö° Create Custom Drill
            </button>
        </section>

        <!-- Search and Filters -->
        <section class="glass-card mb-xl">
            <div class="p-lg">
                <div class="grid grid-2 gap-lg mb-lg">
                    <div>
                        <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs);">
                            Search Drills
                        </label>
                        <input type="text" class="glass-input" placeholder="Search by name, skill, or equipment..." 
                               id="searchInput" onkeyup="filterDrills()">
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs);">
                            Difficulty Level
                        </label>
                        <select class="glass-input" id="difficultyFilter" onchange="filterDrills()">
                            <option value="">All Levels</option>
                            <option value="1">Beginner (‚≠ê)</option>
                            <option value="2">Easy (‚≠ê‚≠ê)</option>
                            <option value="3">Intermediate (‚≠ê‚≠ê‚≠ê)</option>
                            <option value="4">Advanced (‚≠ê‚≠ê‚≠ê‚≠ê)</option>
                            <option value="5">Expert (‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê)</option>
                        </select>
                    </div>
                </div>

                <!-- Ownership Filter -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs);">
                        Drill Ownership
                    </label>
                    <div style="display: flex; gap: var(--spacing-xs);">
                        <button id="allDrillsOwnershipTab" class="ownership-tab active" onclick="setOwnershipFilter('all')" 
                                style="flex: 1; padding: var(--spacing-sm); border: 1px solid var(--glass-border); background: var(--accent-blue); color: white; border-radius: var(--radius-sm); font-size: var(--font-size-sm); cursor: pointer; transition: all 0.3s ease; border: none; outline: none;">
                            üåç All Drills
                        </button>
                        <button id="myDrillsOwnershipTab" class="ownership-tab" onclick="setOwnershipFilter('personal')" 
                                style="flex: 1; padding: var(--spacing-sm); border: 1px solid var(--glass-border); background: var(--glass-secondary); color: var(--text-secondary); border-radius: var(--radius-sm); font-size: var(--font-size-sm); cursor: pointer; transition: all 0.3s ease; border: none; outline: none;">
                            üë§ My Drills
                        </button>
                        <button id="publicDrillsOwnershipTab" class="ownership-tab" onclick="setOwnershipFilter('public')" 
                                style="flex: 1; padding: var(--spacing-sm); border: 1px solid var(--glass-border); background: var(--glass-secondary); color: var(--text-secondary); border-radius: var(--radius-sm); font-size: var(--font-size-sm); cursor: pointer; transition: all 0.3s ease; border: none; outline: none;">
                            üîó Public Drills
                        </button>
                    </div>
                </div>

                <div class="filter-tabs">
                    <div class="filter-tab active" onclick="filterByCategory('all')">All Drills</div>
                    <div class="filter-tab" onclick="filterByCategory('favorites')">‚≠ê Favorites</div>
                    <div class="filter-tab" onclick="filterByCategory('Warm-up')">Warm-up</div>
                    <div class="filter-tab" onclick="filterByCategory('Offense')">Offense</div>
                    <div class="filter-tab" onclick="filterByCategory('Defense')">Defense</div>
                    <div class="filter-tab" onclick="filterByCategory('Serve/Receive')">Serve/Receive</div>
                    <div class="filter-tab" onclick="filterByCategory('Conditioning')">Conditioning</div>
                </div>
            </div>
        </section>

        <!-- Quick Stats -->
        <section class="glass-card mb-xl">
            <div class="p-lg">
                <h2 class="mb-lg" style="color: var(--accent-orange); font-size: var(--font-size-xl);">
                    üìä Drill Statistics
                </h2>
                <div class="grid grid-2 gap-md">
                    <div class="text-center">
                        <div style="font-size: var(--font-size-2xl); font-weight: 700; color: var(--accent-orange);" id="totalDrills">0</div>
                        <div style="color: var(--text-secondary); font-size: var(--font-size-sm);">Total Drills</div>
                    </div>
                    <div class="text-center">
                        <div style="font-size: var(--font-size-2xl); font-weight: 700; color: var(--accent-amber);" id="favoriteDrills">0</div>
                        <div style="color: var(--text-secondary); font-size: var(--font-size-sm);">Favorites</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Drill Cards -->
        <section class="grid grid-3 gap-lg" id="drillGrid">
            <!-- Drills will be loaded here -->
        </section>

        <!-- Custom Drill Builder Modal (Hidden by default) -->
        <div id="customDrillModal" class="modal" style="display: none;">
            <div class="modal-content" style="width: 95%; max-width: 800px; max-height: 95vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 style="color: var(--accent-orange); margin: 0;">‚ö° Create Custom Drill</h2>
                    <button class="modal-close" onclick="closeCustomDrillModal()">‚úï</button>
                </div>
                
                <form id="customDrillForm" onsubmit="saveCustomDrill(event)" style="padding: var(--spacing-lg);">
                    <!-- Basic Info Section -->
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md); font-size: var(--font-size-md); border-bottom: 1px solid var(--glass-border); padding-bottom: var(--spacing-xs);">Basic Information</h3>
                        
                        <div style="margin-bottom: var(--spacing-md);">
                            <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Drill Name</label>
                            <input type="text" id="drillName" name="name" class="glass-input" placeholder="Enter drill name..." required style="width: 100%; padding: var(--spacing-sm);">
                        </div>

                        <div class="grid grid-3 gap-md">
                            <div>
                                <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Category</label>
                                <select id="drillCategory" name="category" class="glass-input" required style="width: 100%; padding: var(--spacing-sm);">
                                    <option value="">Select Category</option>
                                    <option value="Warm-up">Warm-up</option>
                                    <option value="Offense">Offense</option>
                                    <option value="Defense">Defense</option>
                                    <option value="Serve/Receive">Serve/Receive</option>
                                    <option value="Conditioning">Conditioning</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Difficulty</label>
                                <select id="drillDifficulty" name="difficulty" class="glass-input" required style="width: 100%; padding: var(--spacing-sm);">
                                    <option value="">Select Difficulty</option>
                                    <option value="1">1 - Beginner</option>
                                    <option value="2">2 - Easy</option>
                                    <option value="3">3 - Intermediate</option>
                                    <option value="4">4 - Advanced</option>
                                    <option value="5">5 - Elite</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Duration (min)</label>
                                <input type="number" id="drillDuration" name="duration" class="glass-input" placeholder="15" min="1" max="120" required style="width: 100%; padding: var(--spacing-sm);">
                            </div>
                        </div>
                    </div>

                    <!-- Description Section -->
                    <div style="margin-bottom: var(--spacing-lg);">
                        <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Description</label>
                        <textarea id="drillDescription" name="description" class="glass-input" rows="3" placeholder="Describe the drill objective, setup, and execution..." required style="width: 100%; padding: var(--spacing-sm); resize: vertical;"></textarea>
                    </div>

                    <!-- Logistics Section -->
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md); font-size: var(--font-size-md); border-bottom: 1px solid var(--glass-border); padding-bottom: var(--spacing-xs);">Logistics & Equipment</h3>

                        
                        <div class="grid grid-2 gap-md" style="margin-bottom: var(--spacing-md);">
                            <div>
                                <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Min Players</label>
                                <input type="number" id="drillMinPlayers" name="minPlayers" class="glass-input" placeholder="4" min="1" max="20" required style="width: 100%; padding: var(--spacing-sm);">
                            </div>
                            <div>
                                <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Max Players</label>
                                <input type="number" id="drillMaxPlayers" name="maxPlayers" class="glass-input" placeholder="12" min="1" max="20" required style="width: 100%; padding: var(--spacing-sm);">
                            </div>
                        </div>

                        <div class="grid grid-2 gap-md">
                            <div>
                                <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Equipment Needed</label>
                                <div id="equipmentSelector" style="background: var(--glass-primary); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); padding: var(--spacing-md); min-height: 80px; max-height: 100px; overflow-y: auto;">
                                    <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
                                        <!-- Equipment options will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div style="display: flex; gap: var(--spacing-xs); margin-top: var(--spacing-xs);">
                                    <input type="text" id="newEquipmentInput" placeholder="Add equipment..." style="flex: 1; padding: var(--spacing-xs); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--glass-secondary); color: var(--text-primary); font-size: var(--font-size-sm);">
                                    <button type="button" onclick="addCustomEquipment()" style="padding: var(--spacing-xs) var(--spacing-sm); background: var(--accent-orange); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: var(--font-size-sm);">Add</button>
                                </div>
                                <input type="hidden" id="drillEquipment" name="equipment">
                            </div>
                            
                            <div>
                                <label style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Focus Areas</label>
                                <div id="focusSelector" style="background: var(--glass-primary); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); padding: var(--spacing-md); min-height: 80px; max-height: 100px; overflow-y: auto;">
                                    <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
                                        <!-- Focus options will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div style="display: flex; gap: var(--spacing-xs); margin-top: var(--spacing-xs);">
                                    <input type="text" id="newFocusInput" placeholder="Add focus area..." style="flex: 1; padding: var(--spacing-xs); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--glass-secondary); color: var(--text-primary); font-size: var(--font-size-sm);">
                                    <button type="button" onclick="addCustomFocus()" style="padding: var(--spacing-xs) var(--spacing-sm); background: var(--accent-orange); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: var(--font-size-sm);">Add</button>
                                </div>
                                <input type="hidden" id="drillFocus" name="focus">
                            </div>
                        </div>
                    </div>

                    <!-- Sharing Settings Section -->
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md); font-size: var(--font-size-md); border-bottom: 1px solid var(--glass-border); padding-bottom: var(--spacing-xs);">Sharing Settings</h3>
                        
                        <div style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--glass-secondary); border-radius: var(--radius-sm); border: 1px solid var(--glass-border);">
                            <label style="display: flex; align-items: center; cursor: pointer; color: var(--text-primary); font-weight: 500;">
                                <input type="checkbox" id="drillIsPublic" name="is_public" style="margin-right: var(--spacing-sm); width: 18px; height: 18px; accent-color: var(--accent-orange);">
                                <span>üåç Make this drill public</span>
                            </label>
                            <div style="font-size: var(--font-size-sm); color: var(--text-tertiary); flex: 1;">
                                Public drills can be viewed and used by other coaches in the community
                            </div>
                        </div>
                    </div>

                    <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); text-align: center; margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: var(--glass-tertiary); border-radius: var(--radius-sm); border: 1px solid var(--glass-border);">
                        üí° Click tags to select ‚Ä¢ Type and press "Add" to create custom options ‚Ä¢ <span style="color: #4CAF50;">Right-click custom options</span> to remove them
                    </div>

                    <div class="modal-actions" style="padding-top: var(--spacing-md); border-top: 1px solid var(--glass-border);">
                        <button type="button" class="glass-button" onclick="closeCustomDrillModal()" style="padding: var(--spacing-sm) var(--spacing-lg);">Cancel</button>
                        <button type="submit" class="glass-button primary" style="padding: var(--spacing-sm) var(--spacing-lg);">Save Drill</button>
                    </div>
                                    
                            </div>
                        </div>
                </form>
            </div>
        </div>

        <!-- Drill Details Modal -->
        <div id="drillDetailsModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 id="drillDetailsModalTitle">Drill Details</h2>
                    <button class="modal-close" onclick="closeDrillDetailsModal()">‚úï</button>
                </div>
                
                <div class="modal-body">
                    <div style="margin-bottom: var(--spacing-lg);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                            <div>
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Category</div>
                                <div id="drillDetailsCategory" style="color: var(--text-primary); font-weight: 500;"></div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Difficulty</div>
                                <div id="drillDetailsDifficulty" style="color: var(--text-primary); font-weight: 500;"></div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Duration</div>
                                <div id="drillDetailsDuration" style="color: var(--text-primary); font-weight: 500;"></div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Players</div>
                                <div id="drillDetailsPlayers" style="color: var(--text-primary); font-weight: 500;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: var(--spacing-md);">
                            <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Description</div>
                            <div id="drillDetailsDescription" style="color: var(--text-primary); line-height: 1.6;"></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                            <div>
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Equipment</div>
                                <ul id="drillDetailsEquipment" style="color: var(--text-primary); margin: 0; padding-left: var(--spacing-md);"></ul>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Focus Areas</div>
                                <ul id="drillDetailsFocus" style="color: var(--text-primary); margin: 0; padding-left: var(--spacing-md);"></ul>
                            </div>
                        </div>
                        
                        <div id="drillDetailsCreator" style="font-size: var(--font-size-xs); color: var(--text-tertiary); text-align: center; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--glass-border);"></div>
                    </div>
                </div>
                
                <div class="modal-actions" style="padding-top: var(--spacing-md); border-top: 1px solid var(--glass-border);">
                    <button type="button" class="glass-button primary" onclick="closeDrillDetailsModal()" style="padding: var(--spacing-sm) var(--spacing-lg);">Close</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let allDrills = [];
        let filteredDrills = [];
        let favoriteDrills = JSON.parse(localStorage.getItem('favoriteDrills')) || [];
        
        // Ownership filter state
        let currentOwnershipFilter = 'all'; // 'all', 'personal', 'public'
        let currentUser = null;
        
        // Base equipment and focus options
        let equipmentOptions = [
            'Cones', 'Extra Antenna', 'Tape/Lines', 'Scoreboard','Blocking Pads', 'Boxes'
        ];
        
        let focusOptions = [
            'Serving', 'Passing', 'Setting', 'Attacking', 'Blocking', 'Digging',
            'Communication', 'Footwork', 'Timing', 'Coordination', 'Conditioning',
            'Team Play', 'Defense', 'Offense', 'Rotation', 'Strategy',
            'Mental Toughness', 'Leadership', 'Ball Control', 'Court Awareness'
        ];
        
        let selectedEquipment = [];
        let selectedFocus = [];

        // Load custom options from localStorage
        function loadCustomOptions() {
            const customEquipment = JSON.parse(localStorage.getItem('customEquipment')) || [];
            const customFocus = JSON.parse(localStorage.getItem('customFocus')) || [];
            
            // Add custom options to the arrays if they don't already exist
            customEquipment.forEach(option => {
                if (!equipmentOptions.includes(option)) {
                    equipmentOptions.push(option);
                }
            });
            
            customFocus.forEach(option => {
                if (!focusOptions.includes(option)) {
                    focusOptions.push(option);
                }
            });
        }

        // Load drill data
        async function loadDrillData() {
            try {
                const response = await fetch('/api/drills');
                allDrills = await response.json();
                
                // Get current user info for ownership filtering
                currentUser = JSON.parse(localStorage.getItem('user')) || { id: 1, username: 'DemoUser' };
                
                // Filter drills based on visibility rules
                allDrills = filterDrillsByVisibility(allDrills);
                filteredDrills = [...allDrills];
                
                // Clean up favorites - remove any drill IDs that no longer exist
                const existingDrillIds = allDrills.map(drill => drill.id);
                const originalFavoritesLength = favoriteDrills.length;
                favoriteDrills = favoriteDrills.filter(id => existingDrillIds.includes(id));
                
                // Update localStorage if favorites were cleaned up
                if (favoriteDrills.length !== originalFavoritesLength) {
                    localStorage.setItem('favoriteDrills', JSON.stringify(favoriteDrills));
                }
                
                updateStatistics();
                renderDrills();
            } catch (error) {
                console.error('Error loading drill data:', error);
                // Demo mode - load from localStorage
                allDrills = JSON.parse(localStorage.getItem('practrac_drills')) || [];
                
                // Filter drills based on visibility rules
                allDrills = filterDrillsByVisibility(allDrills);
                filteredDrills = [...allDrills];
                
                // Clean up favorites - remove any drill IDs that no longer exist
                const existingDrillIds = allDrills.map(drill => drill.id);
                const originalFavoritesLength = favoriteDrills.length;
                favoriteDrills = favoriteDrills.filter(id => existingDrillIds.includes(id));
                
                // Update localStorage if favorites were cleaned up
                if (favoriteDrills.length !== originalFavoritesLength) {
                    localStorage.setItem('favoriteDrills', JSON.stringify(favoriteDrills));
                }
                
                updateStatistics();
                renderDrills();
            }
        }



        function updateStatistics() {
            document.getElementById('totalDrills').textContent = allDrills.length;
            document.getElementById('favoriteDrills').textContent = favoriteDrills.length;
        }

        // Filter drills based on visibility rules - simplified to show all drills
        function filterDrillsByVisibility(drills) {
            // Simply return all drills since we removed public/private logic
            return drills;
        }

        // Multi-select functionality
        function initializeSelectors() {
            initializeEquipmentSelector();
            initializeFocusSelector();
        }

        function initializeEquipmentSelector() {
            const container = document.querySelector('#equipmentSelector > div');
            const customEquipment = JSON.parse(localStorage.getItem('customEquipment')) || [];
            
            container.innerHTML = equipmentOptions.map(option => {
                const isCustom = customEquipment.includes(option);
                return `<span class="option-tag ${isCustom ? 'custom' : ''}" onclick="toggleEquipment('${option}')" oncontextmenu="${isCustom ? `removeCustomEquipment('${option}'); return false;` : 'return true;'}" data-option="${option}" ${isCustom ? 'title="Right-click to remove"' : ''}>
                    ${option}${isCustom ? ' <span style="color: #4CAF50;">‚òÖ</span>' : ''}
                </span>`;
            }).join('');
        }

        function initializeFocusSelector() {
            const container = document.querySelector('#focusSelector > div');
            const customFocus = JSON.parse(localStorage.getItem('customFocus')) || [];
            
            container.innerHTML = focusOptions.map(option => {
                const isCustom = customFocus.includes(option);
                return `<span class="option-tag ${isCustom ? 'custom' : ''}" onclick="toggleFocus('${option}')" oncontextmenu="${isCustom ? `removeCustomFocus('${option}'); return false;` : 'return true;'}" data-option="${option}" ${isCustom ? 'title="Right-click to remove"' : ''}>
                    ${option}${isCustom ? ' <span style="color: #4CAF50;">‚òÖ</span>' : ''}
                </span>`;
            }).join('');
        }

        function toggleEquipment(option) {
            const index = selectedEquipment.indexOf(option);
            if (index === -1) {
                selectedEquipment.push(option);
            } else {
                selectedEquipment.splice(index, 1);
            }
            updateEquipmentDisplay();
            updateEquipmentInput();
        }

        function toggleFocus(option) {
            const index = selectedFocus.indexOf(option);
            if (index === -1) {
                selectedFocus.push(option);
            } else {
                selectedFocus.splice(index, 1);
            }
            updateFocusDisplay();
            updateFocusInput();
        }

        function updateEquipmentDisplay() {
            const tags = document.querySelectorAll('#equipmentSelector .option-tag');
            tags.forEach(tag => {
                const option = tag.getAttribute('data-option');
                if (selectedEquipment.includes(option)) {
                    tag.classList.add('selected');
                } else {
                    tag.classList.remove('selected');
                }
            });
        }

        function updateFocusDisplay() {
            const tags = document.querySelectorAll('#focusSelector .option-tag');
            tags.forEach(tag => {
                const option = tag.getAttribute('data-option');
                if (selectedFocus.includes(option)) {
                    tag.classList.add('selected');
                } else {
                    tag.classList.remove('selected');
                }
            });
        }

        function updateEquipmentInput() {
            document.getElementById('drillEquipment').value = selectedEquipment.join(', ');
        }

        function updateFocusInput() {
            document.getElementById('drillFocus').value = selectedFocus.join(', ');
        }

        function resetSelectors() {
            // Default equipment (balls and net are always available)
            selectedEquipment = ['Balls', 'Net'];
            selectedFocus = [];
            updateEquipmentDisplay();
            updateFocusDisplay();
            updateEquipmentInput();
            updateFocusInput();
        }

        // Custom option management
        function addCustomEquipment() {
            const input = document.getElementById('newEquipmentInput');
            const newOption = input.value.trim();
            
            if (!newOption) {
                alert('Please enter an equipment name');
                return;
            }
            
            if (equipmentOptions.includes(newOption)) {
                alert('This equipment option already exists');
                input.value = '';
                return;
            }
            
            // Add to options array
            equipmentOptions.push(newOption);
            
            // Save to localStorage
            const customEquipment = JSON.parse(localStorage.getItem('customEquipment')) || [];
            if (!customEquipment.includes(newOption)) {
                customEquipment.push(newOption);
                localStorage.setItem('customEquipment', JSON.stringify(customEquipment));
            }
            
            // Clear input
            input.value = '';
            
            // Reinitialize selector with new option
            initializeEquipmentSelector();
            updateEquipmentDisplay();
            
            // Auto-select the new option
            selectedEquipment.push(newOption);
            updateEquipmentDisplay();
            updateEquipmentInput();
        }

        function addCustomFocus() {
            const input = document.getElementById('newFocusInput');
            const newOption = input.value.trim();
            
            if (!newOption) {
                alert('Please enter a focus area name');
                return;
            }
            
            if (focusOptions.includes(newOption)) {
                alert('This focus area already exists');
                input.value = '';
                return;
            }
            
            // Add to options array
            focusOptions.push(newOption);
            
            // Save to localStorage
            const customFocus = JSON.parse(localStorage.getItem('customFocus')) || [];
            if (!customFocus.includes(newOption)) {
                customFocus.push(newOption);
                localStorage.setItem('customFocus', JSON.stringify(customFocus));
            }
            
            // Clear input
            input.value = '';
            
            // Reinitialize selector with new option
            initializeFocusSelector();
            updateFocusDisplay();
            
            // Auto-select the new option
            selectedFocus.push(newOption);
            updateFocusDisplay();
            updateFocusInput();
        }

        // Remove custom options
        function removeCustomEquipment(option) {
            if (confirm(`Remove "${option}" from custom equipment options?`)) {
                // Remove from options array
                const index = equipmentOptions.indexOf(option);
                if (index > -1) {
                    equipmentOptions.splice(index, 1);
                }
                
                // Remove from localStorage
                const customEquipment = JSON.parse(localStorage.getItem('customEquipment')) || [];
                const customIndex = customEquipment.indexOf(option);
                if (customIndex > -1) {
                    customEquipment.splice(customIndex, 1);
                    localStorage.setItem('customEquipment', JSON.stringify(customEquipment));
                }
                
                // Remove from selected if it was selected
                const selectedIndex = selectedEquipment.indexOf(option);
                if (selectedIndex > -1) {
                    selectedEquipment.splice(selectedIndex, 1);
                }
                
                // Reinitialize and update displays
                initializeEquipmentSelector();
                updateEquipmentDisplay();
                updateEquipmentInput();
            }
        }

        function removeCustomFocus(option) {
            if (confirm(`Remove "${option}" from custom focus area options?`)) {
                // Remove from options array
                const index = focusOptions.indexOf(option);
                if (index > -1) {
                    focusOptions.splice(index, 1);
                }
                
                // Remove from localStorage
                const customFocus = JSON.parse(localStorage.getItem('customFocus')) || [];
                const customIndex = customFocus.indexOf(option);
                if (customIndex > -1) {
                    customFocus.splice(customIndex, 1);
                    localStorage.setItem('customFocus', JSON.stringify(customFocus));
                }
                
                // Remove from selected if it was selected
                const selectedIndex = selectedFocus.indexOf(option);
                if (selectedIndex > -1) {
                    selectedFocus.splice(selectedIndex, 1);
                }
                
                // Reinitialize and update displays
                initializeFocusSelector();
                updateFocusDisplay();
                updateFocusInput();
            }
        }

        // Allow Enter key to add options
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.id === 'newEquipmentInput') {
                    event.preventDefault();
                    addCustomEquipment();
                } else if (activeElement && activeElement.id === 'newFocusInput') {
                    event.preventDefault();
                    addCustomFocus();
                }
            }
        });

        function toggleFavorite(drillId) {
            const index = favoriteDrills.indexOf(drillId);
            if (index === -1) {
                favoriteDrills.push(drillId);
            } else {
                favoriteDrills.splice(index, 1);
            }
            localStorage.setItem('favoriteDrills', JSON.stringify(favoriteDrills));
            updateStatistics();
            renderDrills();
        }

        function editDrill(drillId) {
            const drill = allDrills.find(d => d.id === drillId);
            if (drill) {
                // Check ownership before allowing edit
                const currentUser = JSON.parse(localStorage.getItem('user')) || { id: 1, username: 'DemoUser' };
                if (drill.user_id != currentUser.id) {
                    alert('You can only edit drills that you created.');
                    return;
                }
                
                // Update modal title for editing
                document.querySelector('#customDrillModal h2').textContent = '‚úèÔ∏è Edit Drill';
                
                // Initialize selectors first
                initializeSelectors();
                
                // Populate edit form with drill data
                document.getElementById('drillName').value = drill.name;
                document.getElementById('drillCategory').value = drill.category;
                document.getElementById('drillDescription').value = drill.description;
                document.getElementById('drillDuration').value = drill.duration;
                document.getElementById('drillMinPlayers').value = drill.minPlayers;
                document.getElementById('drillMaxPlayers').value = drill.maxPlayers;
                document.getElementById('drillDifficulty').value = drill.difficulty;
                
                // Set public checkbox - handle both is_public and isPublic field names
                document.getElementById('drillIsPublic').checked = drill.is_public || drill.isPublic || false;
                
                // Set selected equipment and focus
                selectedEquipment = Array.isArray(drill.equipment) ? drill.equipment : (drill.equipment ? [drill.equipment] : []);
                selectedFocus = Array.isArray(drill.focus) ? drill.focus : (drill.focus ? [drill.focus] : []);
                
                // Update displays and inputs
                updateEquipmentDisplay();
                updateFocusDisplay();
                updateEquipmentInput();
                updateFocusInput();
                
                // Show modal
                document.getElementById('customDrillModal').style.display = 'flex';
                
                // Store the drill ID for editing
                document.getElementById('customDrillForm').setAttribute('data-edit-id', drillId);
            }
        }

        function renderDrills() {
            const drillGrid = document.getElementById('drillGrid');
            drillGrid.innerHTML = '';
            
            // Get current user from localStorage (set by main.js) or fallback to demo user with correct ID type
            const currentUser = JSON.parse(localStorage.getItem('user')) || { id: 1 };

            filteredDrills.forEach(drill => {
                const card = document.createElement('div');
                card.className = `drill-card ${favoriteDrills.includes(drill.id) ? 'favorite' : ''}`;
                
                // Create star rating
                const stars = Array.from({length: 5}, (_, i) => 
                    `<span class="star ${i < drill.difficulty ? '' : 'empty'}">‚≠ê</span>`
                ).join('');

                // Get category color
                const categoryColors = {
                    'Warm-up': 'var(--accent-green)',
                    'Offense': 'var(--accent-orange)', 
                    'Defense': 'var(--accent-blue)',
                    'Serve/Receive': 'var(--accent-amber)'
                };

                const isFavorite = favoriteDrills.includes(drill.id);

                card.innerHTML = `
                    <button class="favorite-star ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${drill.id})">
                        ‚≠ê
                    </button>
                    
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-sm);">
                        <div class="drill-category" style="background: ${categoryColors[drill.category] || 'var(--accent-blue)'};">
                            ${drill.category}
                        </div>
                        <div style="font-size: var(--font-size-xs); padding: 2px 6px; border-radius: var(--radius-sm); background: ${drill.is_public || drill.isPublic ? 'var(--accent-green)' : 'var(--glass-border)'}; color: ${drill.is_public || drill.isPublic ? 'white' : 'var(--text-tertiary)'};">
                            ${drill.is_public || drill.isPublic ? 'üåç Public' : 'üîí Private'}
                        </div>
                    </div>
                    
                    <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-sm); font-size: var(--font-size-lg);">
                        ${drill.name}
                    </h3>
                    
                    <div class="drill-difficulty">
                        ${stars}
                        <span style="color: var(--text-secondary); margin-left: var(--spacing-sm); font-size: var(--font-size-sm);">
                            Level ${drill.difficulty}
                        </span>
                    </div>
                    
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md); line-height: 1.5;">
                        ${drill.description}
                    </p>
                    
                    <div style="color: var(--text-tertiary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">
                        <div><strong>Duration:</strong> ${drill.duration} minutes</div>
                        <div><strong>Players:</strong> ${drill.minPlayers}-${drill.maxPlayers}</div>
                        <div><strong>Equipment:</strong> ${Array.isArray(drill.equipment) ? drill.equipment.join(', ') : (drill.equipment || 'None specified')}</div>
                    </div>
                    
                    <div style="background: var(--glass-tertiary); border-radius: var(--radius-sm); padding: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">
                            <strong>Focus Areas:</strong>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
                            ${Array.isArray(drill.focus) ? drill.focus.map(skill => 
                                `<span style="background: var(--glass-primary); color: var(--accent-orange); padding: 2px 6px; border-radius: 0px; font-size: 10px;">${skill}</span>`
                            ).join('') : (drill.focus ? `<span style="background: var(--glass-primary); color: var(--accent-orange); padding: 2px 6px; border-radius: 0px; font-size: 10px;">${drill.focus}</span>` : '')}
                        </div>
                    </div>

                    <div class="flex-center mt-md">
                        <div style="display: flex; gap: var(--spacing-sm); width: 100%;">
                            ${drill.user_id == currentUser.id ? `
                                <button class="glass-button primary" onclick="editDrill(${drill.id})" style="flex: 1;">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="glass-button danger" onclick="deleteDrill(${drill.id}, '${drill.name}')" style="flex: 1;">
                                    üóëÔ∏è Delete
                                </button>
                            ` : `
                                <button class="glass-button primary" onclick="viewDrillDetails(${drill.id})" style="width: 100%;">
                                    ÔøΩÔ∏è View Details
                                </button>
                            `}
                        </div>
                        ${drill.user_id != currentUser.id && drill.creatorName ? `
                            <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); text-align: center; margin-top: var(--spacing-xs);">
                                Created by ${drill.creatorName}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                drillGrid.appendChild(card);
            });
        }

        function filterDrills() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const difficultyFilter = document.getElementById('difficultyFilter').value;
            
            // Start with all drills
            filteredDrills = [...allDrills];
            
            // Apply category filter first
            const activeTab = document.querySelector('.filter-tab.active');
            if (activeTab) {
                const category = activeTab.textContent.includes('All') ? 'all' : 
                                activeTab.textContent.includes('Favorites') ? 'favorites' :
                                activeTab.textContent.trim();
                
                if (category === 'favorites') {
                    filteredDrills = filteredDrills.filter(drill => favoriteDrills.includes(drill.id));
                } else if (category !== 'all') {
                    filteredDrills = filteredDrills.filter(drill => drill.category === category);
                }
            }
            
            // Apply ownership filter
            applyOwnershipFilter();
            
            // Apply search and difficulty filters
            filteredDrills = filteredDrills.filter(drill => {
                const matchesSearch = drill.name.toLowerCase().includes(searchTerm) ||
                                    drill.description.toLowerCase().includes(searchTerm) ||
                                    (Array.isArray(drill.focus) ? drill.focus.some(skill => skill.toLowerCase().includes(searchTerm)) : 
                                     drill.focus && drill.focus.toLowerCase().includes(searchTerm));
                
                const matchesDifficulty = !difficultyFilter || drill.difficulty.toString() === difficultyFilter;
                
                return matchesSearch && matchesDifficulty;
            });
            
            renderDrills();
        }

        function filterByCategory(category) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            if (category === 'all') {
                filteredDrills = [...allDrills];
            } else if (category === 'favorites') {
                filteredDrills = allDrills.filter(drill => favoriteDrills.includes(drill.id));
            } else {
                filteredDrills = allDrills.filter(drill => drill.category === category);
            }
            
            // Apply ownership filter to the category-filtered results
            applyOwnershipFilter();
            renderDrills();
        }

        function setOwnershipFilter(filterType) {
            currentOwnershipFilter = filterType;
            updateOwnershipTabs();
            
            // Re-apply current category filter and then ownership filter
            const activeTab = document.querySelector('.filter-tab.active');
            const category = activeTab ? (activeTab.textContent.includes('All') ? 'all' : 
                                        activeTab.textContent.includes('Favorites') ? 'favorites' :
                                        activeTab.textContent.trim()) : 'all';
            
            if (category === 'all') {
                filteredDrills = [...allDrills];
            } else if (category === 'favorites') {
                filteredDrills = allDrills.filter(drill => favoriteDrills.includes(drill.id));
            } else {
                filteredDrills = allDrills.filter(drill => drill.category === category);
            }
            
            // Apply ownership filter
            applyOwnershipFilter();
            
            // Apply other active filters (search, difficulty)
            filterDrills();
        }

        function updateOwnershipTabs() {
            // Reset all ownership tabs
            document.querySelectorAll('.ownership-tab').forEach(tab => {
                tab.style.background = 'var(--glass-secondary)';
                tab.style.color = 'var(--text-secondary)';
            });

            // Activate current tab
            let activeTab;
            switch(currentOwnershipFilter) {
                case 'all':
                    activeTab = document.getElementById('allDrillsOwnershipTab');
                    break;
                case 'personal':
                    activeTab = document.getElementById('myDrillsOwnershipTab');
                    break;
                case 'public':
                    activeTab = document.getElementById('publicDrillsOwnershipTab');
                    break;
            }
            
            if (activeTab) {
                activeTab.style.background = 'var(--accent-blue)';
                activeTab.style.color = 'white';
            }
        }

        function applyOwnershipFilter() {
            if (currentOwnershipFilter === 'personal') {
                filteredDrills = filteredDrills.filter(drill => drill.user_id == currentUser.id);
            } else if (currentOwnershipFilter === 'public') {
                filteredDrills = filteredDrills.filter(drill => drill.user_id != currentUser.id && (drill.is_public || drill.isPublic));
            }
            // 'all' doesn't need additional filtering
        }

        function viewDrillDetails(drillId) {
            const drill = allDrills.find(d => d.id === drillId);
            if (drill) {
                // Populate the drill details modal
                document.getElementById('drillDetailsModalTitle').textContent = drill.name;
                document.getElementById('drillDetailsCategory').textContent = drill.category;
                document.getElementById('drillDetailsDescription').textContent = drill.description;
                document.getElementById('drillDetailsDuration').textContent = `${drill.duration} minutes`;
                document.getElementById('drillDetailsPlayers').textContent = `${drill.minPlayers}-${drill.maxPlayers} players`;
                document.getElementById('drillDetailsDifficulty').textContent = `Level ${drill.difficulty}`;
                
                // Equipment list
                const equipmentList = document.getElementById('drillDetailsEquipment');
                if (Array.isArray(drill.equipment) && drill.equipment.length > 0) {
                    equipmentList.innerHTML = drill.equipment.map(item => `<li>${item}</li>`).join('');
                } else {
                    equipmentList.innerHTML = '<li>None specified</li>';
                }
                
                // Focus areas
                const focusList = document.getElementById('drillDetailsFocus');
                if (Array.isArray(drill.focus) && drill.focus.length > 0) {
                    focusList.innerHTML = drill.focus.map(skill => `<li>${skill}</li>`).join('');
                } else {
                    focusList.innerHTML = '<li>General skills</li>';
                }
                
                // Creator attribution
                if (drill.creatorName) {
                    document.getElementById('drillDetailsCreator').textContent = `Created by ${drill.creatorName}`;
                    document.getElementById('drillDetailsCreator').style.display = 'block';
                } else {
                    document.getElementById('drillDetailsCreator').style.display = 'none';
                }
                
                // Show the modal
                document.getElementById('drillDetailsModal').style.display = 'flex';
            }
        }

        function closeDrillDetailsModal() {
            document.getElementById('drillDetailsModal').style.display = 'none';
        }

        function createCustomDrill() {
            // Update modal title for creating
            document.querySelector('#customDrillModal h2').textContent = '‚ö° Create Custom Drill';
            
            // Reset form for new drill
            document.getElementById('customDrillForm').reset();
            document.getElementById('customDrillForm').removeAttribute('data-edit-id');
            
            // Reset public checkbox to false for new drills
            document.getElementById('drillIsPublic').checked = false;
            
            // Initialize selectors and reset selections
            initializeSelectors();
            resetSelectors();
            
            document.getElementById('customDrillModal').style.display = 'flex';
        }

        function closeCustomDrillModal() {
            document.getElementById('customDrillModal').style.display = 'none';
            document.getElementById('customDrillForm').reset();
            document.getElementById('drillIsPublic').checked = false;
            resetSelectors();
        }

        async function saveCustomDrill(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const editId = event.target.getAttribute('data-edit-id');
            
            // Get current user info
            const currentUser = JSON.parse(localStorage.getItem('user')) || { id: 1, username: 'DemoUser' };
            
            const drillData = {
                name: formData.get('name'),
                category: formData.get('category'),
                duration: parseInt(formData.get('duration')),
                difficulty: parseInt(formData.get('difficulty')),
                description: formData.get('description'),
                equipment: formData.get('equipment') ? formData.get('equipment').split(',').map(item => item.trim()) : [],
                minPlayers: parseInt(formData.get('minPlayers')),
                maxPlayers: parseInt(formData.get('maxPlayers')),
                focus: formData.get('focus') ? formData.get('focus').split(',').map(item => item.trim()) : [],
                is_public: document.getElementById('drillIsPublic').checked
            };

            try {
                const isEdit = editId !== null;
                const url = isEdit ? `/api/drills/${editId}` : '/api/drills';
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(drillData)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Close modal and refresh the drill list
                    closeCustomDrillModal();
                    loadDrillData();
                    
                    // Show success notification
                    window.pracTracDemo?.showNotification(
                        `Drill ${isEdit ? 'updated' : 'created'} successfully!`,
                        'success'
                    );
                } else {
                    throw new Error(`Failed to ${isEdit ? 'update' : 'create'} drill`);
                }
            } catch (error) {
                console.error(`Error ${editId ? 'updating' : 'creating'} drill:`, error);
                
                // Demo mode - save to localStorage with simplified structure
                try {
                    let drills = JSON.parse(localStorage.getItem('practrac_drills')) || [];
                    
                    if (isEdit) {
                        // Update existing drill
                        const drillIndex = drills.findIndex(d => d.id === parseInt(editId));
                        if (drillIndex !== -1) {
                            drills[drillIndex] = {
                                ...drillData,
                                id: parseInt(editId)
                            };
                        }
                    } else {
                        // Create new drill
                        const newId = Math.max(...drills.map(d => d.id || 0), 0) + 1;
                        drillData.id = newId;
                        drills.push(drillData);
                    }
                    
                    localStorage.setItem('practrac_drills', JSON.stringify(drills));
                    
                    // Close modal and refresh
                    closeCustomDrillModal();
                    loadDrillData();
                    
                    // Show success notification
                    window.pracTracDemo?.showNotification(
                        `Drill ${isEdit ? 'updated' : 'created'} successfully!`,
                        'success'
                    );
                } catch (localStorageError) {
                    console.error('Error saving to localStorage:', localStorageError);
                    window.pracTracDemo?.showNotification(
                        `Error ${editId ? 'updating' : 'creating'} drill`,
                        'error'
                    );
                }
            }
        }

        async function deleteDrill(drillId, drillName) {
            // Ensure drillId is an integer for proper comparison
            drillId = parseInt(drillId);
            
            // Check ownership before allowing delete
            const drill = allDrills.find(d => d.id === drillId);
            if (drill) {
                const currentUser = JSON.parse(localStorage.getItem('user')) || { id: 1, username: 'DemoUser' };
                if (drill.user_id != currentUser.id) {
                    alert('You can only delete drills that you created.');
                    return;
                }
            }
            
            const confirmed = confirm(`Are you sure you want to delete "${drillName}"? This action cannot be undone.`);
            
            if (confirmed) {
                try {
                    const response = await fetch(`/api/drills/${drillId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        // Remove drill from favorites if it was favorited
                        const favoriteIndex = favoriteDrills.indexOf(drillId);
                        if (favoriteIndex !== -1) {
                            favoriteDrills.splice(favoriteIndex, 1);
                            localStorage.setItem('favoriteDrills', JSON.stringify(favoriteDrills));
                        }
                        
                        window.pracTracDemo?.showNotification('Drill deleted successfully', 'success');
                        loadDrillData(); // Reload the drills list
                    } else {
                        throw new Error('Failed to delete drill');
                    }
                } catch (error) {
                    console.error('Error deleting drill:', error);
                    
                    // Demo mode - delete from localStorage
                    try {
                        let drills = JSON.parse(localStorage.getItem('practrac_drills')) || [];
                        drills = drills.filter(drill => drill.id !== drillId);
                        localStorage.setItem('practrac_drills', JSON.stringify(drills));
                        
                        // Remove from favorites if it was favorited
                        const favoriteIndex = favoriteDrills.indexOf(drillId);
                        if (favoriteIndex !== -1) {
                            favoriteDrills.splice(favoriteIndex, 1);
                            localStorage.setItem('favoriteDrills', JSON.stringify(favoriteDrills));
                        }
                        
                        window.pracTracDemo?.showNotification('Drill deleted successfully', 'success');
                        loadDrillData(); // Reload the drills list
                    } catch (localStorageError) {
                        console.error('Error deleting from localStorage:', localStorageError);
                        window.pracTracDemo?.showNotification('Error deleting drill', 'error');
                    }
                }
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomOptions();
            loadDrillData();
            // Initialize ownership filter tabs
            updateOwnershipTabs();
            // Initialize mobile menu
            if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
        });
    </script>
    <script src="js/main.js"></script>
    <script>
        // Initialize PracTrac demo and check authentication
        window.pracTracDemo = new PracTracDemo();
    </script>
    <script src="/js/modal.js"></script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--glass-primary);
            border: 1px solid var(--glass-border);
            border-radius: 0;
            padding: var(--spacing-xl);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: var(--font-size-xl);
            cursor: pointer;
            padding: var(--spacing-sm);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            margin-top: var(--spacing-lg);
        }
    </style>
</body>
</html>