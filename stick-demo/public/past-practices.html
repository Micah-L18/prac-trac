<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Past Practices - PracTrac</title>
    <link rel="stylesheet" href="css/glass-style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-content">
            <a href="index.html" class="logo">üèê PracTrac</a>
            
            <!-- Mobile menu toggle button -->
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            
            <!-- Desktop navigation -->
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="practice.html">Practice Plans</a></li>
                    <li><a href="past-practices.html" class="active">Past Practices</a></li>
                    <li><a href="roster.html">Roster</a></li>
                    <li><a href="drills.html">Drills</a></li>
                    <li><a href="settings.html">Settings</a></li>
                </ul>
            </nav>
            
            <!-- Mobile menu -->
            <nav class="mobile-menu">
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="practice.html">Practice Plans</a></li>
                    <li><a href="past-practices.html" class="active">Past Practices</a></li>
                    <li><a href="roster.html">Roster</a></li>
                    <li><a href="drills.html">Drills</a></li>
                    <li><a href="settings.html">Settings</a></li>
                </ul>
            </nav>
            
            <div class="nav-user">
                <span id="userGreeting">Guest User</span>
                <a href="login.html" class="login-link" style="margin-left: 10px;">Login</a>
                <div id="teamSelector" class="team-selector-container" style="display: none; margin-left: 10px;">
                    <!-- Team selector will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </nav>

    <main class="main-container">
        <!-- Header -->
        <section class="flex-between mb-xl">
            <div>
                <h1 class="text-2xl font-bold mb-sm">Past Practice Sessions</h1>
                <p class="text-secondary">Review completed practices with attendance records and performance notes</p>
            </div>
        </section>

        <!-- Filter and Stats -->
        <section class="mb-lg">
            <div class="glass-card p-lg">
                <div class="grid grid-3 gap-lg">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-accent mb-xs" id="totalSessions">-</div>
                        <div class="text-secondary">Total Sessions</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-success mb-xs" id="avgAttendance">-</div>
                        <div class="text-secondary">Average Attendance</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-primary mb-xs" id="totalHours">-</div>
                        <div class="text-secondary">Total Practice Hours</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Past Sessions List -->
        <div id="sessionsList" class="sessions-list">
            <!-- Practice sessions will be loaded here -->
        </div>
    </main>

    <!-- Session Details Modal -->
    <div id="sessionDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="modalSessionTitle" style="color: var(--accent-orange); margin: 0;">Practice Session Details</h2>
                <button class="modal-close" onclick="closeSessionDetails()">‚úï</button>
            </div>
            
            <div id="sessionDetailsContent">
                <!-- Session details will be loaded here -->
            </div>

            <div class="modal-actions">
                <button type="button" class="glass-button" onclick="closeSessionDetails()">Close</button>
            </div>
        </div>
    </div>

    <!-- Game Details Modal -->
    <div id="gameDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="gameModalTitle" style="color: var(--accent-orange); margin: 0;">Game Details</h2>
                <button class="modal-close" onclick="closeGameDetails()">‚úï</button>
            </div>
            
            <div id="gameDetailsContent">
                <!-- Game details will be loaded here -->
            </div>

            <div class="modal-actions">
                <button type="button" class="glass-button" onclick="closeGameDetails()">Close</button>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--glass-primary);
            border: 1px solid var(--glass-border);
            border-radius: 0;
            padding: var(--spacing-xl);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: var(--font-size-xl);
            cursor: pointer;
            padding: var(--spacing-sm);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            margin-top: var(--spacing-lg);
        }
    </style>

    <script>
        let pastSessions = [];

        async function loadPastSessions() {
            try {
                const response = await fetch('/api/practice-sessions');
                const data = await response.json();
                
                // Check if response is successful and data is an array
                if (response.ok && Array.isArray(data)) {
                    pastSessions = data;
                } else {
                    console.error('API returned non-array data:', data);
                    pastSessions = [];
                }
                
                displaySessions();
                updateStats();
            } catch (error) {
                console.error('Error loading past sessions:', error);
                pastSessions = [];
                document.getElementById('sessionsList').innerHTML = 
                    '<div class="glass-card p-lg text-center">Error loading practice sessions. Please try again.</div>';
            }
        }

        async function displaySessions() {
            const sessionsList = document.getElementById('sessionsList');
            
            // Safety check to ensure pastSessions is an array
            if (!Array.isArray(pastSessions)) {
                console.error('pastSessions is not an array:', pastSessions);
                pastSessions = [];
            }
            
            await displayPastSessions(pastSessions);
        }

        async function displayPastSessions(pastSessions) {
            const sessionsList = document.getElementById('sessionsList');
            
            if (!pastSessions || pastSessions.length === 0) {
                sessionsList.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                        <div style="font-size: var(--font-size-xl); margin-bottom: var(--spacing-md);">üìã</div>
                        <div style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-sm);">No practice sessions found</div>
                        <div style="font-size: var(--font-size-sm);">Start a practice to see it appear here.</div>
                    </div>
                `;
                return;
            }

            // Get score counts for all sessions
            const sessionScoreCounts = await Promise.all(
                pastSessions.map(session => getScoreCountForSession(session.id))
            );

            sessionsList.innerHTML = pastSessions.map((session, index) => {
                const startDate = new Date(session.started_at);
                const statusBadge = getStatusBadge(session.status);
                const attendancePercentage = session.total_players > 0 ? 
                    Math.round((session.attended_count / session.total_players) * 100) : 0;
                
                const scoreCount = sessionScoreCounts[index];
                const scoreBadge = scoreCount > 0 ? 
                    `<span style="color: var(--accent-blue); font-weight: 500; font-size: var(--font-size-sm);">üèê ${scoreCount} game${scoreCount !== 1 ? 's' : ''}</span>` : '';

                return `
                    <div class="glass-card" style="padding: var(--spacing-lg); margin-bottom: var(--spacing-md); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                                <h3 style="margin: 0; color: var(--text-primary); font-size: var(--font-size-lg);">${session.practice_name}</h3>
                                ${statusBadge}
                                <span style="color: var(--accent-orange); font-weight: 500; font-size: var(--font-size-sm);">
                                    üë• ${session.attended_count}/${session.total_players} (${attendancePercentage}%)
                                </span>
                                ${scoreBadge}
                            </div>
                            <div style="display: flex; gap: var(--spacing-lg); margin-bottom: var(--spacing-xs);">
                                <p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">üìÖ ${startDate.toLocaleDateString()}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">‚è∞ ${startDate.toLocaleTimeString()}</p>
                                ${session.actual_duration ? `<p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">‚è±Ô∏è ${session.actual_duration} min</p>` : ''}
                            </div>
                            <p style="margin: 0; color: var(--text-tertiary); font-size: var(--font-size-sm); line-height: 1.4;">${session.objective || 'No objective set'}</p>
                        </div>
                        <div style="display: flex; gap: var(--spacing-sm); margin-left: var(--spacing-lg);">
                            ${session.status === 'in_progress' ? `
                                <button class="glass-button" onclick="resumePractice(${session.practice_id}, ${session.id})" style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm); background: var(--success-bg); color: var(--success-text);">
                                    ‚ñ∂Ô∏è Resume
                                </button>
                            ` : ''}
                            <button class="glass-button" onclick="viewSessionDetails(${session.id})" style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm);">
                                üëÅÔ∏è View Details
                            </button>
                            <button class="glass-button danger" onclick="deletePracticeSession(${session.id}, '${session.practice_name}', '${startDate.toLocaleDateString()}')" style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm);">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Helper function to get score count for a session
        async function getScoreCountForSession(sessionId) {
            try {
                const response = await fetch(`/api/practice-sessions/${sessionId}/scores`);
                if (!response.ok) {
                    return 0;
                }
                const scores = await response.json();
                return scores.length;
            } catch (error) {
                console.error('Error getting score count for session:', sessionId, error);
                return 0;
            }
        }

        async function displayPastSessions(pastSessions) {
            if (!pastSessions || pastSessions.length === 0) {
                sessionsList.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                        <div style="font-size: var(--font-size-xl); margin-bottom: var(--spacing-md);">üìã</div>
                        <div style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-sm);">No practice sessions found</div>
                        <div style="font-size: var(--font-size-sm);">Start a practice to see it appear here.</div>
                    </div>
                `;
                return;
            }

            // Get score counts for all sessions
            const sessionScoreCounts = await Promise.all(
                pastSessions.map(session => getScoreCountForSession(session.id))
            );

            sessionsList.innerHTML = pastSessions.map((session, index) => {
                const startDate = new Date(session.started_at);
                const statusBadge = getStatusBadge(session.status);
                const attendancePercentage = session.total_players > 0 ? 
                    Math.round((session.attended_count / session.total_players) * 100) : 0;
                
                const scoreCount = sessionScoreCounts[index];
                const scoreBadge = scoreCount > 0 ? 
                    `<span style="color: var(--accent-blue); font-weight: 500; font-size: var(--font-size-sm);">üèê ${scoreCount} game${scoreCount !== 1 ? 's' : ''}</span>` : '';

                return `
                    <div class="glass-card" style="padding: var(--spacing-lg); margin-bottom: var(--spacing-md); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                                <h3 style="margin: 0; color: var(--text-primary); font-size: var(--font-size-lg);">${session.practice_name}</h3>
                                ${statusBadge}
                                <span style="color: var(--accent-orange); font-weight: 500; font-size: var(--font-size-sm);">
                                    üë• ${session.attended_count}/${session.total_players} (${attendancePercentage}%)
                                </span>
                                ${scoreBadge}
                            </div>
                            <div style="display: flex; gap: var(--spacing-lg); margin-bottom: var(--spacing-xs);">
                                <p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">üìÖ ${startDate.toLocaleDateString()}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">‚è∞ ${startDate.toLocaleTimeString()}</p>
                                ${session.actual_duration ? `<p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">‚è±Ô∏è ${session.actual_duration} min</p>` : ''}
                            </div>
                            <p style="margin: 0; color: var(--text-tertiary); font-size: var(--font-size-sm); line-height: 1.4;">${session.objective || 'No objective set'}</p>
                        </div>
                        <div style="display: flex; gap: var(--spacing-sm); margin-left: var(--spacing-lg);">
                            ${session.status === 'in_progress' ? `
                                <button class="glass-button" onclick="resumePractice(${session.practice_id}, ${session.id})" style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm); background: var(--success-bg); color: var(--success-text);">
                                    ‚ñ∂Ô∏è Resume
                                </button>
                            ` : ''}
                            <button class="glass-button" onclick="viewSessionDetails(${session.id})" style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm);">
                                üëÅÔ∏è View Details
                            </button>
                            <button class="glass-button danger" onclick="deletePracticeSession(${session.id}, '${session.practice_name}', '${startDate.toLocaleDateString()}')" style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm);">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                'completed': '<span style="background: var(--success-bg); color: var(--success-text); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600;">‚úÖ Completed</span>',
                'in_progress': '<span style="background: var(--warning-bg); color: var(--warning-text); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600;">‚è≥ In Progress</span>',
                'cancelled': '<span style="background: var(--error-bg); color: var(--error-text); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600;">‚ùå Cancelled</span>'
            };
            return badges[status] || '';
        }

        function updateStats() {
            const totalSessions = pastSessions.length;
            const totalPlayers = pastSessions.reduce((sum, session) => sum + (session.total_players || 0), 0);
            const totalAttended = pastSessions.reduce((sum, session) => sum + (session.attended_count || 0), 0);
            const avgAttendance = totalPlayers > 0 ? Math.round((totalAttended / totalPlayers) * 100) : 0;
            
            const completedSessions = pastSessions.filter(s => s.status === 'completed' && s.actual_duration);
            const totalMinutes = completedSessions.reduce((sum, session) => sum + (session.actual_duration || 0), 0);
            const totalHours = Math.round(totalMinutes / 60 * 10) / 10;

            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('avgAttendance').textContent = `${avgAttendance}%`;
            document.getElementById('totalHours').textContent = `${totalHours}h`;
        }

        async function viewSessionDetails(sessionId) {
            try {
                // Fetch both session details and the full practice details
                const sessionResponse = await fetch(`/api/practice-sessions/${sessionId}`);
                const session = await sessionResponse.json();
                
                const practiceResponse = await fetch(`/api/practices/${session.practice_id}`);
                const practice = await practiceResponse.json();
                
                document.getElementById('modalSessionTitle').textContent = `${session.practice_name} - Session Details`;
                
                const startDate = new Date(session.started_at);
                const endDate = session.completed_at ? new Date(session.completed_at) : null;
                
                const attendanceGrid = session.attendance.map(record => {
                    const statusIcon = record.attended ? '‚úÖ' : '‚ùå';
                    const lateInfo = record.attended && record.late_minutes > 0 ? ` (${record.late_minutes} min late)` : '';
                    
                    return `
                        <div class="glass-card" style="padding: var(--spacing-md); display: flex; justify-content: between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                                <div style="font-size: var(--font-size-lg);">#${record.jerseyNumber}</div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${record.firstName} ${record.lastName}</div>
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-sm);">${record.position}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                <span style="font-size: var(--font-size-lg);">${statusIcon}</span>
                                <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                                    ${record.attended ? 'Present' : 'Absent'}${lateInfo}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');

                // Create practice phases section
                const phasesSection = practice.phases && practice.phases.length > 0 ? `
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">Practice Plan - Phases & Drills</h3>
                        <div style="background: var(--glass-secondary); border-radius: var(--radius-md); padding: var(--spacing-md); border: 1px solid var(--glass-border);">
                            <div style="margin-bottom: var(--spacing-sm);">
                                <strong style="color: var(--text-primary);">Practice Objective:</strong>
                                <div style="color: var(--text-secondary); margin-top: var(--spacing-xs);">${practice.objective || 'No objective set'}</div>
                            </div>
                            <div style="margin-bottom: var(--spacing-sm);">
                                <strong style="color: var(--text-primary);">Estimated Duration:</strong>
                                <span style="color: var(--accent-orange); margin-left: var(--spacing-xs);">${practice.estimated_duration} minutes</span>
                            </div>
                        </div>
                        <div style="margin-top: var(--spacing-md);">
                            ${practice.phases.map((phase, index) => `
                                <div class="glass-card" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                                        <h4 style="margin: 0; color: var(--text-primary);">üéØ Phase ${index + 1}: ${phase.name}</h4>
                                        <span style="color: var(--accent-orange); font-weight: 600;">${phase.duration} min</span>
                                    </div>
                                    ${phase.objective ? `
                                        <div style="color: var(--text-secondary); margin-bottom: var(--spacing-sm); font-style: italic;">
                                            ${phase.objective}
                                        </div>
                                    ` : ''}
                                    ${phase.drills && phase.drills.length > 0 ? `
                                        <div>
                                            <strong style="color: var(--text-primary); font-size: var(--font-size-sm);">Drills:</strong>
                                            <div style="margin-top: var(--spacing-xs);">
                                                ${phase.drills.map(drill => `
                                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--glass-border);">
                                                        <div>
                                                            <span style="font-weight: 600; color: var(--text-primary);">${drill.name}</span>
                                                            <span style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-left: var(--spacing-sm);">
                                                                üìã ${drill.category} ‚Ä¢ ‚≠ê ${drill.difficulty}
                                                            </span>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : '<div style="color: var(--text-secondary); font-size: var(--font-size-sm);">No drills assigned</div>'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                document.getElementById('sessionDetailsContent').innerHTML = `
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">Session Information</h3>
                        <div class="grid grid-2 gap-md">
                            <div class="glass-card p-md">
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Started</div>
                                <div style="font-weight: 600;">${startDate.toLocaleString()}</div>
                            </div>
                            ${endDate ? `
                                <div class="glass-card p-md">
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Completed</div>
                                    <div style="font-weight: 600;">${endDate.toLocaleString()}</div>
                                </div>
                            ` : ''}
                            <div class="glass-card p-md">
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Status</div>
                                <div>${getStatusBadge(session.status)}</div>
                            </div>
                            ${session.actual_duration ? `
                                <div class="glass-card p-md">
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Actual Duration</div>
                                    <div style="font-weight: 600;">${session.actual_duration} minutes</div>
                                </div>
                            ` : ''}
                        </div>
                        ${session.notes ? `
                            <div class="glass-card p-md" style="margin-top: var(--spacing-md);">
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Session Notes</div>
                                <div style="line-height: 1.5;">${session.notes}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${phasesSection}
                    
                    <div id="scoresSection" style="margin-bottom: var(--spacing-lg);">
                        <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">Game Scores</h3>
                        <div id="scoresContent">
                            <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                                Loading saved scores...
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">Attendance Record</h3>
                        <div class="grid grid-2 gap-sm">
                            ${attendanceGrid}
                        </div>
                    </div>
                    
                    <div id="playerNotesSection" style="margin-top: var(--spacing-lg);">
                        <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">Player Notes</h3>
                        <div id="playerNotesContent">
                            <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                                Loading player notes...
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('sessionDetailsModal').style.display = 'flex';
                
                // Load player notes and scores after displaying the modal
                loadPlayerNotesForSession(sessionId);
                loadScoresForSession(session, sessionId);
            } catch (error) {
                console.error('Error loading session details:', error);
                glassModal.error('Error loading session details. Please try again.', 'Loading Failed');
            }
        }

        async function loadScoresForSession(session, sessionId) {
            try {
                const scoresContent = document.getElementById('scoresContent');
                
                // Load scores from database API
                const response = await fetch(`/api/practice-sessions/${sessionId}/scores`);
                if (!response.ok) {
                    throw new Error('Failed to load scores from database');
                }
                
                const savedScores = await response.json();
                
                if (savedScores.length === 0) {
                    scoresContent.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary); background: var(--glass-secondary); border-radius: var(--radius-md); border: 1px solid var(--glass-border);">
                            <div style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-sm);">üèê</div>
                            <div>No game scores recorded for this practice session.</div>
                            <div style="font-size: var(--font-size-sm); margin-top: var(--spacing-xs); color: var(--text-tertiary);">
                                Use the scoreboard in Practice Mode to save game scores.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Display the saved scores
                const scoresGrid = savedScores.map((score, index) => {
                    const scoreTime = new Date(score.created_at);
                    const winner = score.team_a_score > score.team_b_score ? score.team_a_name : 
                                  score.team_b_score > score.team_a_score ? score.team_b_name : null;
                    const isDraw = score.team_a_score === score.team_b_score;
                    
                    // Parse team rosters if available
                    let teamARoster = [];
                    let teamBRoster = [];
                    
                    try {
                        if (score.team_a_roster) {
                            teamARoster = JSON.parse(score.team_a_roster);
                        }
                        if (score.team_b_roster) {
                            teamBRoster = JSON.parse(score.team_b_roster);
                        }
                    } catch (e) {
                        console.error('Error parsing team rosters for score:', score.id, e);
                    }
                    
                    // Generate team roster HTML
                    const generateRosterHTML = (roster, teamName) => {
                        if (!roster || roster.length === 0) {
                            return `<div style="color: var(--text-tertiary); font-style: italic;">No roster data available</div>`;
                        }
                        
                        return roster.map(player => `
                            <div style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--glass-border);">
                                <div style="background: var(--accent-blue); color: white; padding: var(--spacing-xs); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: bold; min-width: 28px; text-align: center;">
                                    ${player.jerseyNumber || '#'}
                                </div>
                                <div style="flex: 1; font-weight: 500;">${player.name}</div>
                                ${player.position ? `<div style="color: var(--text-secondary); font-size: var(--font-size-sm);">${player.position}</div>` : ''}
                            </div>
                        `).join('');
                    };
                    
                    const hasRosterData = teamARoster.length > 0 || teamBRoster.length > 0;
                    
                    return `
                        <div class="glass-card game-card-clickable" style="padding: var(--spacing-lg); margin-bottom: var(--spacing-md); cursor: pointer; transition: all 0.2s ease;" onclick="openGameDetails(${JSON.stringify(score).replace(/"/g, '&quot;')}, ${index + 1})" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 32px rgba(255,140,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-md);">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                                        <span style="font-size: var(--font-size-lg);">üèê</span>
                                        <h4 style="margin: 0; color: var(--text-primary);">Game ${index + 1}</h4>
                                        ${score.phase_name ? `<span style="background: var(--accent-blue); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600;">${score.phase_name}</span>` : ''}
                                        ${score.drill_name ? `<span style="background: var(--accent-orange); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600;">${score.drill_name}</span>` : ''}
                                        <span style="background: var(--glass-secondary); color: var(--text-secondary); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 500;">Click to view details</span>
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                                        ‚è∞ ${scoreTime.toLocaleTimeString()}
                                        ${score.game_time ? ` ‚Ä¢ Game Duration: ${score.game_time}` : ''}
                                    </div>
                                </div>
                                ${winner ? `
                                    <div style="text-align: right;">
                                        <div style="background: var(--success-bg); color: var(--success-text); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600; margin-bottom: var(--spacing-xs);">
                                            üèÜ ${winner} Wins!
                                        </div>
                                    </div>
                                ` : isDraw ? `
                                    <div style="text-align: right;">
                                        <div style="background: var(--warning-bg); color: var(--warning-text); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600; margin-bottom: var(--spacing-xs);">
                                            ü§ù Draw
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="display: flex; justify-content: center; gap: var(--spacing-xl); margin-bottom: var(--spacing-md);">
                                <div style="text-align: center;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);">${score.team_a_name}</div>
                                    <div style="font-size: 2rem; font-weight: bold; color: ${score.team_a_score > score.team_b_score ? 'var(--success-text)' : 'var(--text-primary)'}; 
                                         background: ${score.team_a_score > score.team_b_score ? 'var(--success-bg)' : 'var(--glass-secondary)'}; 
                                         padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); border: 1px solid var(--glass-border);">
                                        ${score.team_a_score}
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: center; color: var(--text-secondary); font-size: var(--font-size-lg); font-weight: bold;">
                                    VS
                                </div>
                                
                                <div style="text-align: center;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);">${score.team_b_name}</div>
                                    <div style="font-size: 2rem; font-weight: bold; color: ${score.team_b_score > score.team_a_score ? 'var(--success-text)' : 'var(--text-primary)'}; 
                                         background: ${score.team_b_score > score.team_a_score ? 'var(--success-bg)' : 'var(--glass-secondary)'}; 
                                         padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); border: 1px solid var(--glass-border);">
                                        ${score.team_b_score}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                scoresContent.innerHTML = `
                    <div style="margin-bottom: var(--spacing-md);">
                        <div style="background: var(--glass-secondary); border-radius: var(--radius-md); padding: var(--spacing-md); border: 1px solid var(--glass-border); text-align: center;">
                            <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Total Games Recorded</div>
                            <div style="font-size: var(--font-size-xl); font-weight: bold; color: var(--accent-orange);">${savedScores.length}</div>
                        </div>
                    </div>
                    ${scoresGrid}
                `;
                
            } catch (error) {
                console.error('Error loading scores for session:', error);
                document.getElementById('scoresContent').innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary); background: var(--error-bg); border-radius: var(--radius-md); border: 1px solid var(--error-border);">
                        <div>Error loading game scores. Please try again.</div>
                    </div>
                `;
            }
        }

        function closeSessionDetails() {
            document.getElementById('sessionDetailsModal').style.display = 'none';
        }

        async function deletePracticeSession(sessionId, practiceName, sessionDate) {
            const confirmed = await showGlassConfirm(
                `Are you sure you want to delete the practice session "${practiceName}" from ${sessionDate}? This action cannot be undone and will remove all attendance records for this session.`,
                'Delete Practice Session'
            );
            
            if (confirmed) {
                fetch(`/api/practice-sessions/${sessionId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showGlassError(`Error: ${data.error}`);
                    } else {
                        showGlassSuccess('Practice session deleted successfully');
                        loadPastSessions(); // Reload the sessions list
                    }
                })
                .catch(error => {
                    console.error('Error deleting practice session:', error);
                    showGlassError('Error deleting practice session');
                });
            }
        }

        function resumePractice(practiceId, sessionId) {
            // Navigate to practice mode with the existing session
            window.location.href = `practice-mode.html?practice=${practiceId}&session=${sessionId}&resume=true`;
        }

        async function loadPlayerNotesForSession(sessionId) {
            try {
                const playerNotesContent = document.getElementById('playerNotesContent');
                
                // First fetch all players who attended this session
                const sessionResponse = await fetch(`/api/practice-sessions/${sessionId}`);
                const session = await sessionResponse.json();
                
                if (!session.attendance || session.attendance.length === 0) {
                    playerNotesContent.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                            No attendance records found for this session.
                        </div>
                    `;
                    return;
                }

                // Fetch player notes for each player in the session
                const playerNotesPromises = session.attendance.map(async (record) => {
                    try {
                        // Use player_id (snake_case) from the database record
                        const response = await fetch(`/api/practice-sessions/${sessionId}/player-notes/${record.player_id}`);
                        if (response.ok) {
                            const notes = await response.json();
                            return {
                                player: record,
                                notes: notes
                            };
                        }
                        return {
                            player: record,
                            notes: []
                        };
                    } catch (error) {
                        console.error(`Error loading notes for player ${record.player_id}:`, error);
                        return {
                            player: record,
                            notes: []
                        };
                    }
                });

                const playerNotesResults = await Promise.all(playerNotesPromises);
                
                // Filter to only show players who have notes
                const playersWithNotes = playerNotesResults.filter(result => result.notes && result.notes.length > 0);
                
                if (playersWithNotes.length === 0) {
                    playerNotesContent.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                            No player notes were recorded for this practice session.
                        </div>
                    `;
                    return;
                }

                // Generate the player notes HTML
                const playerNotesHtml = playersWithNotes.map(result => {
                    const { player, notes } = result;
                    
                    const notesHtml = notes.map(note => {
                        const noteDate = new Date(note.created_at);
                        const noteTypeIcon = note.note_type === 'practice' ? 'üìù' : 'üë§';
                        const noteTypeLabel = note.note_type === 'practice' ? 'Practice Note' : 'Player Note';
                        
                        return `
                            <div class="glass-card" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm); background: var(--glass-secondary);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                        <span style="font-size: var(--font-size-lg);">${noteTypeIcon}</span>
                                        <span style="color: var(--accent-orange); font-weight: 600; font-size: var(--font-size-sm);">${noteTypeLabel}</span>
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-xs);">
                                        ${noteDate.toLocaleDateString()} ${noteDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </div>
                                </div>
                                <div style="line-height: 1.5; color: var(--text-primary);">
                                    ${note.notes}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="glass-card" style="padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 1px solid var(--glass-border);">
                                <div style="font-size: var(--font-size-lg);">#${player.jerseyNumber}</div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: var(--font-size-lg);">
                                        ${player.firstName} ${player.lastName}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                                        ${player.position}
                                    </div>
                                </div>
                            </div>
                            <div>
                                ${notesHtml}
                            </div>
                        </div>
                    `;
                }).join('');

                playerNotesContent.innerHTML = playerNotesHtml;
                
            } catch (error) {
                console.error('Error loading player notes:', error);
                document.getElementById('playerNotesContent').innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-error);">
                        Error loading player notes. Please try again.
                    </div>
                `;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPastSessions();
            // Initialize mobile menu
            if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
        });

        // Open game details modal
        function openGameDetails(scoreData, gameNumber) {
            const modal = document.getElementById('gameDetailsModal');
            const title = document.getElementById('gameModalTitle');
            const content = document.getElementById('gameDetailsContent');
            
            // Set modal title
            title.textContent = `Game ${gameNumber} Details`;
            
            // Parse team rosters if available
            let teamARoster = [];
            let teamBRoster = [];
            
            try {
                if (scoreData.team_a_roster) {
                    teamARoster = JSON.parse(scoreData.team_a_roster);
                }
                if (scoreData.team_b_roster) {
                    teamBRoster = JSON.parse(scoreData.team_b_roster);
                }
            } catch (e) {
                console.error('Error parsing team rosters:', e);
            }
            
            const scoreTime = new Date(scoreData.created_at);
            const winner = scoreData.team_a_score > scoreData.team_b_score ? scoreData.team_a_name : 
                          scoreData.team_b_score > scoreData.team_a_score ? scoreData.team_b_name : null;
            const isDraw = scoreData.team_a_score === scoreData.team_b_score;
            
            // Generate team roster HTML
            const generateRosterHTML = (roster, teamName) => {
                if (!roster || roster.length === 0) {
                    return `<div style="color: var(--text-tertiary); font-style: italic; text-align: center; padding: var(--spacing-md);">No roster data available</div>`;
                }
                
                return roster.map(player => `
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm); margin-bottom: var(--spacing-xs); background: var(--glass-primary); border-radius: var(--radius-sm); border: 1px solid var(--glass-border);">
                        <div style="background: var(--accent-blue); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); font-weight: bold; min-width: 40px; text-align: center;">
                            ${player.jerseyNumber || '#'}
                        </div>
                        <div style="flex: 1; font-weight: 500; color: var(--text-primary);">${player.name}</div>
                        ${player.position ? `<div style="color: var(--text-secondary); font-size: var(--font-size-sm); background: var(--glass-secondary); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm);">${player.position}</div>` : ''}
                    </div>
                `).join('');
            };
            
            const hasRosterData = teamARoster.length > 0 || teamBRoster.length > 0;
            
            content.innerHTML = `
                <!-- Game Header -->
                <div style="text-align: center; margin-bottom: var(--spacing-lg); padding: var(--spacing-lg); background: var(--glass-secondary); border-radius: var(--radius-lg); border: 1px solid var(--glass-border);">
                    <div style="display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <span style="font-size: 2rem;">üèê</span>
                        <h3 style="margin: 0; color: var(--text-primary);">Game ${gameNumber}</h3>
                        ${scoreData.phase_name ? `<span style="background: var(--accent-blue); color: white; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-sm); font-size: var(--font-size-sm); font-weight: 600;">${scoreData.phase_name}</span>` : ''}
                        ${scoreData.drill_name ? `<span style="background: var(--accent-orange); color: white; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-sm); font-size: var(--font-size-sm); font-weight: 600;">${scoreData.drill_name}</span>` : ''}
                    </div>
                    
                    <div style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                        ‚è∞ ${scoreTime.toLocaleDateString()} at ${scoreTime.toLocaleTimeString()}
                        ${scoreData.game_time ? ` ‚Ä¢ Duration: ${scoreData.game_time}` : ''}
                    </div>
                    
                    ${winner ? `
                        <div style="background: var(--success-bg); color: var(--success-text); padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--radius-md); font-weight: 600; margin-bottom: var(--spacing-sm);">
                            üèÜ ${winner} Wins!
                        </div>
                    ` : isDraw ? `
                        <div style="background: var(--warning-bg); color: var(--warning-text); padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--radius-md); font-weight: 600; margin-bottom: var(--spacing-sm);">
                            ü§ù Draw
                        </div>
                    ` : ''}
                </div>
                
                <!-- Score Display -->
                <div style="display: flex; justify-content: center; gap: var(--spacing-xl); margin-bottom: var(--spacing-xl); padding: var(--spacing-xl); background: var(--glass-secondary); border-radius: var(--radius-lg); border: 1px solid var(--glass-border);">
                    <div style="text-align: center; flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-md); font-size: var(--font-size-lg);">${scoreData.team_a_name}</div>
                        <div style="font-size: 4rem; font-weight: bold; color: ${scoreData.team_a_score > scoreData.team_b_score ? 'var(--success-text)' : 'var(--text-primary)'}; 
                             background: ${scoreData.team_a_score > scoreData.team_b_score ? 'var(--success-bg)' : 'var(--glass-primary)'}; 
                             padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 2px solid ${scoreData.team_a_score > scoreData.team_b_score ? 'var(--success-border)' : 'var(--glass-border)'};">
                            ${scoreData.team_a_score}
                        </div>
                        ${hasRosterData && teamARoster.length > 0 ? `<div style="margin-top: var(--spacing-sm); color: var(--text-secondary); font-size: var(--font-size-sm);">${teamARoster.length} players</div>` : ''}
                    </div>
                    
                    <div style="display: flex; align-items: center; color: var(--text-secondary); font-size: var(--font-size-xl); font-weight: bold;">
                        VS
                    </div>
                    
                    <div style="text-align: center; flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-md); font-size: var(--font-size-lg);">${scoreData.team_b_name}</div>
                        <div style="font-size: 4rem; font-weight: bold; color: ${scoreData.team_b_score > scoreData.team_a_score ? 'var(--success-text)' : 'var(--text-primary)'}; 
                             background: ${scoreData.team_b_score > scoreData.team_a_score ? 'var(--success-bg)' : 'var(--glass-primary)'}; 
                             padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 2px solid ${scoreData.team_b_score > scoreData.team_a_score ? 'var(--success-border)' : 'var(--glass-border)'};">
                            ${scoreData.team_b_score}
                        </div>
                        ${hasRosterData && teamBRoster.length > 0 ? `<div style="margin-top: var(--spacing-sm); color: var(--text-secondary); font-size: var(--font-size-sm);">${teamBRoster.length} players</div>` : ''}
                    </div>
                </div>
                
                <!-- Team Rosters -->
                ${hasRosterData ? `
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-md); text-align: center;">Team Rosters</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                            <div style="background: var(--glass-secondary); border-radius: var(--radius-lg); padding: var(--spacing-lg); border: 1px solid var(--glass-border);">
                                <h5 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); justify-content: center;">
                                    <span style="background: var(--accent-blue); color: white; padding: var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); font-weight: bold; min-width: 32px; text-align: center;">A</span>
                                    <span>${scoreData.team_a_name}</span>
                                    <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">(${teamARoster.length})</span>
                                </h5>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${generateRosterHTML(teamARoster, scoreData.team_a_name)}
                                </div>
                            </div>
                            <div style="background: var(--glass-secondary); border-radius: var(--radius-lg); padding: var(--spacing-lg); border: 1px solid var(--glass-border);">
                                <h5 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); justify-content: center;">
                                    <span style="background: var(--accent-orange); color: white; padding: var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); font-weight: bold; min-width: 32px; text-align: center;">B</span>
                                    <span>${scoreData.team_b_name}</span>
                                    <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">(${teamBRoster.length})</span>
                                </h5>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${generateRosterHTML(teamBRoster, scoreData.team_b_name)}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div style="text-align: center; padding: var(--spacing-xl); background: var(--glass-secondary); border-radius: var(--radius-lg); border: 1px solid var(--glass-border); margin-bottom: var(--spacing-lg);">
                        <div style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-sm); color: var(--text-secondary);">üë•</div>
                        <div style="color: var(--text-secondary);">No team roster data available for this game.</div>
                        <div style="font-size: var(--font-size-sm); margin-top: var(--spacing-xs); color: var(--text-tertiary);">
                            Team assignments were not saved when this game was recorded.
                        </div>
                    </div>
                `}
                
                <!-- Game Notes -->
                ${scoreData.notes ? `
                    <div style="background: var(--glass-secondary); border-radius: var(--radius-lg); padding: var(--spacing-lg); border: 1px solid var(--glass-border);">
                        <h5 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm);">
                            <span style="font-size: var(--font-size-lg);">ÔøΩ</span>
                            Game Notes
                        </h5>
                        <div style="color: var(--text-primary); line-height: 1.6; background: var(--glass-primary); padding: var(--spacing-md); border-radius: var(--radius-sm); border: 1px solid var(--glass-border);">
                            ${scoreData.notes}
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Show the modal
            modal.style.display = 'flex';
        }

        // Close game details modal
        function closeGameDetails() {
            document.getElementById('gameDetailsModal').style.display = 'none';
        }

    </script>
    <script src="js/main.js"></script>
    <script>
        // Initialize PracTrac demo and check authentication
        window.pracTracDemo = new PracTracDemo();
    </script>
    <script src="/js/modal.js"></script>
</body>
</html>