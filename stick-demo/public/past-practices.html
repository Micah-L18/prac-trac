<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Past Practices - PracTrac</title>
    <link rel="stylesheet" href="css/glass-style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-glass">
            <a href="index.html" class="logo">üèê PracTrac</a>
            <ul class="nav-links">
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="practice.html">Practice Plans</a></li>
                <li><a href="past-practices.html" class="active">Past Practices</a></li>
                <li><a href="roster.html">Roster</a></li>
                <li><a href="drills.html">Drills</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-container">
        <!-- Header -->
        <section class="flex-between mb-xl">
            <div>
                <h1 class="text-2xl font-bold mb-sm">Past Practice Sessions</h1>
                <p class="text-secondary">Review completed practices with attendance records and performance notes</p>
            </div>
        </section>

        <!-- Filter and Stats -->
        <section class="mb-lg">
            <div class="glass-card p-lg">
                <div class="grid grid-3 gap-lg">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-accent mb-xs" id="totalSessions">-</div>
                        <div class="text-secondary">Total Sessions</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-success mb-xs" id="avgAttendance">-</div>
                        <div class="text-secondary">Average Attendance</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-primary mb-xs" id="totalHours">-</div>
                        <div class="text-secondary">Total Practice Hours</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Past Sessions List -->
        <div id="sessionsList" class="sessions-list">
            <!-- Practice sessions will be loaded here -->
        </div>
    </main>

    <!-- Session Details Modal -->
    <div id="sessionDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="modalSessionTitle" style="color: var(--accent-orange); margin: 0;">Practice Session Details</h2>
                <button class="modal-close" onclick="closeSessionDetails()">‚úï</button>
            </div>
            
            <div id="sessionDetailsContent">
                <!-- Session details will be loaded here -->
            </div>

            <div class="modal-actions">
                <button type="button" class="glass-button" onclick="closeSessionDetails()">Close</button>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--glass-primary);
            border: 1px solid var(--glass-border);
            border-radius: 0;
            padding: var(--spacing-xl);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: var(--font-size-xl);
            cursor: pointer;
            padding: var(--spacing-sm);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            margin-top: var(--spacing-lg);
        }
    </style>

    <script>
        let pastSessions = [];

        async function loadPastSessions() {
            try {
                const response = await fetch('/api/practice-sessions');
                const data = await response.json();
                
                // Check if response is successful and data is an array
                if (response.ok && Array.isArray(data)) {
                    pastSessions = data;
                } else {
                    console.error('API returned non-array data:', data);
                    pastSessions = [];
                }
                
                displaySessions();
                updateStats();
            } catch (error) {
                console.error('Error loading past sessions:', error);
                pastSessions = [];
                document.getElementById('sessionsList').innerHTML = 
                    '<div class="glass-card p-lg text-center">Error loading practice sessions. Please try again.</div>';
            }
        }

        function displaySessions() {
            const sessionsList = document.getElementById('sessionsList');
            
            // Safety check to ensure pastSessions is an array
            if (!Array.isArray(pastSessions)) {
                console.error('pastSessions is not an array:', pastSessions);
                pastSessions = [];
            }
            
            if (pastSessions.length === 0) {
                sessionsList.innerHTML = '<div class="glass-card p-lg text-center">No practice sessions found. Start your first practice to see it here!</div>';
                return;
            }

            sessionsList.innerHTML = pastSessions.map(session => {
                const startDate = new Date(session.started_at);
                const statusBadge = getStatusBadge(session.status);
                const attendancePercentage = session.total_players > 0 ? 
                    Math.round((session.attended_count / session.total_players) * 100) : 0;
                
                return `
                    <div class="glass-card" style="padding: var(--spacing-lg); margin-bottom: var(--spacing-md); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                                <h3 style="margin: 0; color: var(--text-primary); font-size: var(--font-size-lg);">${session.practice_name}</h3>
                                ${statusBadge}
                                <span style="color: var(--accent-orange); font-weight: 500; font-size: var(--font-size-sm);">
                                    üë• ${session.attended_count}/${session.total_players} (${attendancePercentage}%)
                                </span>
                            </div>
                            <div style="display: flex; gap: var(--spacing-lg); margin-bottom: var(--spacing-xs);">
                                <p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">üìÖ ${startDate.toLocaleDateString()}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">‚è∞ ${startDate.toLocaleTimeString()}</p>
                                ${session.actual_duration ? `<p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">‚è±Ô∏è ${session.actual_duration} min</p>` : ''}
                            </div>
                            <p style="margin: 0; color: var(--text-tertiary); font-size: var(--font-size-sm); line-height: 1.4;">${session.objective || 'No objective set'}</p>
                        </div>
                        <div style="display: flex; gap: var(--spacing-sm); margin-left: var(--spacing-lg);">
                            <button class="glass-button" onclick="viewSessionDetails(${session.id})" style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm);">
                                üëÅÔ∏è View Details
                            </button>
                            <button class="glass-button danger" onclick="deletePracticeSession(${session.id}, '${session.practice_name}', '${startDate.toLocaleDateString()}')" style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm);">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                'completed': '<span style="background: var(--success-bg); color: var(--success-text); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600;">‚úÖ Completed</span>',
                'in_progress': '<span style="background: var(--warning-bg); color: var(--warning-text); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600;">‚è≥ In Progress</span>',
                'cancelled': '<span style="background: var(--error-bg); color: var(--error-text); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 600;">‚ùå Cancelled</span>'
            };
            return badges[status] || '';
        }

        function updateStats() {
            const totalSessions = pastSessions.length;
            const totalPlayers = pastSessions.reduce((sum, session) => sum + (session.total_players || 0), 0);
            const totalAttended = pastSessions.reduce((sum, session) => sum + (session.attended_count || 0), 0);
            const avgAttendance = totalPlayers > 0 ? Math.round((totalAttended / totalPlayers) * 100) : 0;
            
            const completedSessions = pastSessions.filter(s => s.status === 'completed' && s.actual_duration);
            const totalMinutes = completedSessions.reduce((sum, session) => sum + (session.actual_duration || 0), 0);
            const totalHours = Math.round(totalMinutes / 60 * 10) / 10;

            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('avgAttendance').textContent = `${avgAttendance}%`;
            document.getElementById('totalHours').textContent = `${totalHours}h`;
        }

        async function viewSessionDetails(sessionId) {
            try {
                // Fetch both session details and the full practice details
                const sessionResponse = await fetch(`/api/practice-sessions/${sessionId}`);
                const session = await sessionResponse.json();
                
                const practiceResponse = await fetch(`/api/practices/${session.practice_id}`);
                const practice = await practiceResponse.json();
                
                document.getElementById('modalSessionTitle').textContent = `${session.practice_name} - Session Details`;
                
                const startDate = new Date(session.started_at);
                const endDate = session.completed_at ? new Date(session.completed_at) : null;
                
                const attendanceGrid = session.attendance.map(record => {
                    const statusIcon = record.attended ? '‚úÖ' : '‚ùå';
                    const lateInfo = record.attended && record.late_minutes > 0 ? ` (${record.late_minutes} min late)` : '';
                    
                    return `
                        <div class="glass-card" style="padding: var(--spacing-md); display: flex; justify-content: between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                                <div style="font-size: var(--font-size-lg);">#${record.jerseyNumber}</div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${record.firstName} ${record.lastName}</div>
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-sm);">${record.position}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                <span style="font-size: var(--font-size-lg);">${statusIcon}</span>
                                <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                                    ${record.attended ? 'Present' : 'Absent'}${lateInfo}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');

                // Create practice phases section
                const phasesSection = practice.phases && practice.phases.length > 0 ? `
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">Practice Plan - Phases & Drills</h3>
                        <div style="background: var(--glass-secondary); border-radius: var(--radius-md); padding: var(--spacing-md); border: 1px solid var(--glass-border);">
                            <div style="margin-bottom: var(--spacing-sm);">
                                <strong style="color: var(--text-primary);">Practice Objective:</strong>
                                <div style="color: var(--text-secondary); margin-top: var(--spacing-xs);">${practice.objective || 'No objective set'}</div>
                            </div>
                            <div style="margin-bottom: var(--spacing-sm);">
                                <strong style="color: var(--text-primary);">Estimated Duration:</strong>
                                <span style="color: var(--accent-orange); margin-left: var(--spacing-xs);">${practice.estimated_duration} minutes</span>
                            </div>
                        </div>
                        <div style="margin-top: var(--spacing-md);">
                            ${practice.phases.map((phase, index) => `
                                <div class="glass-card" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                                        <h4 style="margin: 0; color: var(--text-primary);">üéØ Phase ${index + 1}: ${phase.name}</h4>
                                        <span style="color: var(--accent-orange); font-weight: 600;">${phase.duration} min</span>
                                    </div>
                                    ${phase.objective ? `
                                        <div style="color: var(--text-secondary); margin-bottom: var(--spacing-sm); font-style: italic;">
                                            ${phase.objective}
                                        </div>
                                    ` : ''}
                                    ${phase.drills && phase.drills.length > 0 ? `
                                        <div>
                                            <strong style="color: var(--text-primary); font-size: var(--font-size-sm);">Drills:</strong>
                                            <div style="margin-top: var(--spacing-xs);">
                                                ${phase.drills.map(drill => `
                                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) 0; border-bottom: 1px solid var(--glass-border);">
                                                        <div>
                                                            <span style="font-weight: 600; color: var(--text-primary);">${drill.name}</span>
                                                            <span style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-left: var(--spacing-sm);">
                                                                üìã ${drill.category} ‚Ä¢ ‚≠ê ${drill.difficulty}
                                                            </span>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : '<div style="color: var(--text-secondary); font-size: var(--font-size-sm);">No drills assigned</div>'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                document.getElementById('sessionDetailsContent').innerHTML = `
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">Session Information</h3>
                        <div class="grid grid-2 gap-md">
                            <div class="glass-card p-md">
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Started</div>
                                <div style="font-weight: 600;">${startDate.toLocaleString()}</div>
                            </div>
                            ${endDate ? `
                                <div class="glass-card p-md">
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Completed</div>
                                    <div style="font-weight: 600;">${endDate.toLocaleString()}</div>
                                </div>
                            ` : ''}
                            <div class="glass-card p-md">
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Status</div>
                                <div>${getStatusBadge(session.status)}</div>
                            </div>
                            ${session.actual_duration ? `
                                <div class="glass-card p-md">
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Actual Duration</div>
                                    <div style="font-weight: 600;">${session.actual_duration} minutes</div>
                                </div>
                            ` : ''}
                        </div>
                        ${session.notes ? `
                            <div class="glass-card p-md" style="margin-top: var(--spacing-md);">
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">Session Notes</div>
                                <div style="line-height: 1.5;">${session.notes}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${phasesSection}
                    
                    <div>
                        <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">Attendance Record</h3>
                        <div class="grid grid-2 gap-sm">
                            ${attendanceGrid}
                        </div>
                    </div>
                    
                    <div id="playerNotesSection" style="margin-top: var(--spacing-lg);">
                        <h3 style="margin: 0 0 var(--spacing-md) 0; color: var(--text-primary);">Player Notes</h3>
                        <div id="playerNotesContent">
                            <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                                Loading player notes...
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('sessionDetailsModal').style.display = 'flex';
                
                // Load player notes after displaying the modal
                loadPlayerNotesForSession(sessionId);
            } catch (error) {
                console.error('Error loading session details:', error);
                glassModal.error('Error loading session details. Please try again.', 'Loading Failed');
            }
        }

        function closeSessionDetails() {
            document.getElementById('sessionDetailsModal').style.display = 'none';
        }

        async function deletePracticeSession(sessionId, practiceName, sessionDate) {
            const confirmed = await showGlassConfirm(
                `Are you sure you want to delete the practice session "${practiceName}" from ${sessionDate}? This action cannot be undone and will remove all attendance records for this session.`,
                'Delete Practice Session'
            );
            
            if (confirmed) {
                fetch(`/api/practice-sessions/${sessionId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showGlassError(`Error: ${data.error}`);
                    } else {
                        showGlassSuccess('Practice session deleted successfully');
                        loadPastSessions(); // Reload the sessions list
                    }
                })
                .catch(error => {
                    console.error('Error deleting practice session:', error);
                    showGlassError('Error deleting practice session');
                });
            }
        }

        async function loadPlayerNotesForSession(sessionId) {
            try {
                const playerNotesContent = document.getElementById('playerNotesContent');
                
                // First fetch all players who attended this session
                const sessionResponse = await fetch(`/api/practice-sessions/${sessionId}`);
                const session = await sessionResponse.json();
                
                if (!session.attendance || session.attendance.length === 0) {
                    playerNotesContent.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                            No attendance records found for this session.
                        </div>
                    `;
                    return;
                }

                // Fetch player notes for each player in the session
                const playerNotesPromises = session.attendance.map(async (record) => {
                    try {
                        // Use player_id (snake_case) from the database record
                        const response = await fetch(`/api/practice-sessions/${sessionId}/player-notes/${record.player_id}`);
                        if (response.ok) {
                            const notes = await response.json();
                            return {
                                player: record,
                                notes: notes
                            };
                        }
                        return {
                            player: record,
                            notes: []
                        };
                    } catch (error) {
                        console.error(`Error loading notes for player ${record.player_id}:`, error);
                        return {
                            player: record,
                            notes: []
                        };
                    }
                });

                const playerNotesResults = await Promise.all(playerNotesPromises);
                
                // Filter to only show players who have notes
                const playersWithNotes = playerNotesResults.filter(result => result.notes && result.notes.length > 0);
                
                if (playersWithNotes.length === 0) {
                    playerNotesContent.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                            No player notes were recorded for this practice session.
                        </div>
                    `;
                    return;
                }

                // Generate the player notes HTML
                const playerNotesHtml = playersWithNotes.map(result => {
                    const { player, notes } = result;
                    
                    const notesHtml = notes.map(note => {
                        const noteDate = new Date(note.created_at);
                        const noteTypeIcon = note.note_type === 'practice' ? 'üìù' : 'üë§';
                        const noteTypeLabel = note.note_type === 'practice' ? 'Practice Note' : 'Player Note';
                        
                        return `
                            <div class="glass-card" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm); background: var(--glass-secondary);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                        <span style="font-size: var(--font-size-lg);">${noteTypeIcon}</span>
                                        <span style="color: var(--accent-orange); font-weight: 600; font-size: var(--font-size-sm);">${noteTypeLabel}</span>
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-xs);">
                                        ${noteDate.toLocaleDateString()} ${noteDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </div>
                                </div>
                                <div style="line-height: 1.5; color: var(--text-primary);">
                                    ${note.notes}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="glass-card" style="padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 1px solid var(--glass-border);">
                                <div style="font-size: var(--font-size-lg);">#${player.jerseyNumber}</div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: var(--font-size-lg);">
                                        ${player.firstName} ${player.lastName}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                                        ${player.position}
                                    </div>
                                </div>
                            </div>
                            <div>
                                ${notesHtml}
                            </div>
                        </div>
                    `;
                }).join('');

                playerNotesContent.innerHTML = playerNotesHtml;
                
            } catch (error) {
                console.error('Error loading player notes:', error);
                document.getElementById('playerNotesContent').innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-error);">
                        Error loading player notes. Please try again.
                    </div>
                `;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPastSessions();
        });
    </script>
    <script src="/js/modal.js"></script>
</body>
</html>